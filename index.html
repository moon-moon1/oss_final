<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=500, initial-scale=1, maximum-scale=1" />
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
  <title>ì˜ìƒ í¸ì§‘ ì´ˆë³´ìë¥¼ ìœ„í•œ ì‡¼ì¸ ë§Œë“¤ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #44b4f2;
      --accent: #feb84d;
      --bg: #fafdff;
      --card: #ffffffee;
      --border: #e0e3e7;
      --shadow: 0 2px 8px #0001;
    }
    html,body {
      background: var(--bg);
      font-family: 'Nanum Gothic', sans-serif;
      margin: 0; padding: 0;
      color: #222;
    }
    body {
      max-width: 540px;
      margin: 0 auto; padding: 0 0 80px 0;
    }
    header {
      background: linear-gradient(90deg, #44b4f2 60%, #c5f3fa 100%);
      color: #fff;
      padding: 32px 0 24px 0;
      text-align: center;
      border-radius: 0 0 40px 40px;
      box-shadow: var(--shadow);
    }
    header h1 {
      font-size: 2.1rem;
      font-weight: 700;
      margin: 0 0 10px 0;
      letter-spacing: -1px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
    }
    header .slogan {
      font-size: 1.15rem;
      font-weight: 400;
      margin-bottom: 0;
      opacity: .92;
    }
    .feature-cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin: 22px 0 14px 0;
      gap: 10px;
    }
    .feature-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      width: 120px;
      flex: 0 0 120px;
      box-shadow: var(--shadow);
      padding: 16px 6px 12px 6px;
      text-align: center;
      font-size: 1.07rem;
      color: #444;
      font-weight: 500;
      transition: transform 0.13s;
      display: flex; flex-direction: column; align-items: center; gap: 3px;
    }
    .feature-card:hover {
      transform: translateY(-4px) scale(1.05);
      background: #e7f8fc;
    }
    .feature-card .emoji {
      font-size: 1.6em;
      margin-bottom: 4px;
    }
    main {
      margin: 0;
      padding: 0 12px;
    }
    .editor-section {
      margin: 24px 0 18px 0;
      background: var(--card);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 20px 12px 12px 12px;
      border: 1px solid var(--border);
    }
    .controls label, .controls input, .controls select, .controls button {
      font-size: 1.03em;
    }
    .controls { display: flex; flex-direction: column; gap: 10px; margin: 0 0 12px 0;}
    .controls input, .controls select {
      padding: 5px 7px; border-radius: 7px; border: 1px solid #d2dde8; margin-left: 6px;
      background: #fafbfc;
    }
    .controls button {
      border: none; border-radius: 7px;
      background: var(--primary); color: #fff;
      font-weight: 700; cursor: pointer;
      box-shadow: 0 1px 3px #0002;
      padding: 7px 16px; margin: 2px 0;
      transition: background 0.12s;
    }
    .controls button:disabled {background:#b3def7; color:#f4f7fa;}
    .controls button:not(:disabled):hover {background: var(--accent); color:#322;}
    .video-container { position:relative; width:100%; max-width:420px; margin:16px auto 6px auto;}
    video { width:100%; border-radius: 14px; border:2px solid var(--border);}
    #subtitleOverlay {
      position: absolute; bottom: 32px; width: 100%; text-align: center;
      color: white; font-size: 20px; font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
      pointer-events: none;
      letter-spacing: -1px;
    }
    ul#clipList { padding-left:1rem; max-height:70px; overflow-y:auto; }
    .clip-li {display: flex; justify-content: space-between; align-items: center;}
    .clip-del-btn {margin-left: 10px; color: #f22; font-size: 0.96em; background: #ffe6e6;}
    .clip-del-btn:hover {color: #fff; background: #f22;}
    .step-guide {
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      padding: 18px 14px 14px 14px;
      margin: 32px 0 20px 0;
    }
    .step-guide h2 {
      font-size:1.18rem;
      margin: 0 0 12px 0;
      color: var(--primary);
      letter-spacing:-1px;
    }
    .step-list {list-style:none; padding:0; margin:0;}
    .step-list li {
      margin: 0 0 13px 0; display: flex; align-items: flex-start; gap: 7px;
      font-size:1.04em;
    }
    .step-list .num {
      background: var(--primary);
      color:#fff; border-radius: 50%; width: 1.5em; height: 1.5em; display: flex; align-items: center; justify-content: center; font-weight:700; font-size:1.01em;
      margin-right:5px;
    }
    .faq-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 15px 14px 10px 14px;
      margin-bottom: 24px;
    }
    .faq-section h2 {font-size:1.13rem; color:var(--primary);}
    .faq-list {padding-left: 1.1em;}
    .faq-q {font-weight:700; margin-top:6px; margin-bottom:1px;}
    .faq-a {margin-bottom: 9px; color: #4d4f50;}
    footer {
      text-align: center;
      font-size: .98rem;
      color: #78a2bd;
      margin: 30px 0 16px 0;
      padding: 8px 0 8px 0;
    }
    .gh-link {color:#006ed3; font-weight:700; text-decoration:none;}
    .gh-link:hover {text-decoration:underline;}
    @media (max-width:480px) {
      .feature-card {width:45vw; min-width:100px;}
      .editor-section {padding:11px 3vw;}
      .step-guide {padding:10px 2vw;}
      .faq-section {padding: 7px 3vw;}
      .video-container {max-width:97vw;}
      body {padding:0 0 45px 0;}
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ ì œëª©/ìŠ¬ë¡œê±´ -->
  <header>
    <h1>ğŸ¥ ì˜ìƒ í¸ì§‘ ì´ˆë³´ìë¥¼ ìœ„í•œ<br>ì‡¼ì¸ ë§Œë“¤ê¸°</h1>
    <div class="slogan">ë¯¸ë¦¬ë³´ê¸°ê°€ ì œëŒ€ë¡œ í™œìš© ì•ˆë  ê²½ìš° ë™ì˜ìƒì„ <br>ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ê°•ì œ ì‹œì‘í•˜ì„¸ìš”!</div>
  </header>
  <!-- ê¸°ëŠ¥ ì¹´ë“œ -->
  <div class="feature-cards">
    <div class="feature-card"><span class="emoji">âœ‚ï¸</span>êµ¬ê°„ ìë¥´ê¸°</div>
    <div class="feature-card"><span class="emoji">ğŸ¶</span>ìŒì•… ë³‘í•©</div>
    <div class="feature-card"><span class="emoji">ğŸ“</span>ìë§‰ ì¶”ê°€</div>
    <div class="feature-card"><span class="emoji">ğŸ¨</span>í•„í„°</div>
    <div class="feature-card"><span class="emoji">â•</span>í´ë¦½ ì¶”ê°€/ì‚­ì œ</div>
    <div class="feature-card"><span class="emoji">ğŸ”€</span>í˜ì´ë“œ ë³‘í•©</div>
    <div class="feature-card"><span class="emoji">â©</span>ì†ë„ ì¡°ì ˆ</div>
    <div class="feature-card"><span class="emoji">ğŸ“¸</span>ì¸ë„¤ì¼ ìº¡ì²˜</div>
    <div class="feature-card"><span class="emoji">ğŸ”</span>êµ¬ê°„ ë°˜ë³µ</div>
  </div>

  <main>
    <div class="editor-section">
      <div class="controls">
        <label>ğŸ¥ ë™ì˜ìƒ: <input type="file" id="videoInput" accept="video/*"/></label>
        <label>ğŸµ ìŒì•…:   <input type="file" id="audioInput" accept="audio/*"/></label>
      </div>
      <div class="video-container">
        <video id="preview" controls autoplay playsinline muted></video>
        <div id="subtitleOverlay"></div>
      </div>
      <div class="controls">
        <label>Start (ì´ˆ): <input type="number" id="startSec" value="0" min="0"/></label>
        <label>End   (ì´ˆ): <input type="number" id="endSec"   value="5" min="0"/></label>
        <button id="trimBtn"   disabled>âœ‚ ìë¥´ê¸°</button>
        <button id="mergeBtn"  disabled>ğŸ¶ ë³‘í•©í•˜ê¸°</button>
        <button id="loopBtn"   disabled>ğŸ” êµ¬ê°„ ë°˜ë³µ OFF</button>
      </div>
      <div class="controls">
        <label>í•„í„° ì„ íƒ:
          <select id="filterSelect">
            <option value="none">None</option>
            <option value="hue=s=0">Grayscale</option>
            <option value="colorchannelmixer=0.393:0.769:0.189:0:0.349:0.686:0.168:0:0.272:0.534:0.131">Sepia</option>
            <option value="eq=contrast=1.5:brightness=0.05">Vivid</option>
            <option value="eq=saturation=0.5">Desaturated</option>
          </select>
        </label>
        <button id="applyFilterBtn" disabled>ğŸ¨ í•„í„° í•˜ë“œì½”ë”©</button>
      </div>
      <div class="controls">
        <label>ì†ë„ ì„ íƒ:
          <select id="speedSelect">
            <option value="0.5">0.5Ã— (ëŠë¦¬ê²Œ)</option>
            <option value="1"   selected>1Ã— (ì›ë³¸)</option>
            <option value="1.5">1.5Ã— (ë¹ ë¥´ê²Œ)</option>
            <option value="2">2Ã— (ë” ë¹ ë¥´ê²Œ)</option>
          </select>
        </label>
        <button id="speedBtn" disabled>â© ì†ë„ ì ìš©</button>
      </div>
      <div class="controls">
        <label>ì¸ë„¤ì¼ ì‹œê°„ (ì´ˆ): <input type="number" id="thumbTime" value="1" min="0"/></label>
        <button id="captureThumbBtn" disabled>ğŸ“¸ ì¸ë„¤ì¼ ìº¡ì²˜</button>
      </div>
      <div class="controls">
        <label>ìë§‰ í…ìŠ¤íŠ¸: <input type="text" id="subtitleText" placeholder="ìë§‰ì„ ì…ë ¥í•˜ì„¸ìš”"/></label>
        <label>ì‹œì‘ (ì´ˆ):   <input type="number" id="subtitleStart" value="0" min="0"/></label>
        <label>ì¢…ë£Œ (ì´ˆ):   <input type="number" id="subtitleEnd"   value="3" min="0"/></label>
        <button id="subtitleBtn" disabled>ğŸ“ ìë§‰ ì˜¤ë²„ë ˆì´</button>
      </div>
      <div class="controls">
        <label>Clip Start (ì´ˆ): <input type="number" id="clipStart" value="0" min="0"/></label>
        <label>Clip End   (ì´ˆ): <input type="number" id="clipEnd"   value="5" min="0"/></label>
        <button id="addClipBtn"    disabled>â• í´ë¦½ ì¶”ê°€</button>
        <button id="fadeMergeBtn"  disabled>ğŸ”€ í˜ì´ë“œ ë³‘í•©</button>
      </div>
      <ul id="clipList"></ul>
      <a id="downloadLink" style="display:none" download="final_video.mp4">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</a>
    </div>

    <!-- ì‚¬ìš©ë²•/ê°€ì´ë“œ -->
    <div class="step-guide">
      <h2>ğŸ§© ì‚¬ìš©ë²• (STEP BY STEP)</h2>
      <ul class="step-list">
        <li><span class="num">1</span>ë™ì˜ìƒ íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.</li>
        <li><span class="num">2</span>(í•„ìš”ì‹œ) ìŒì•…ì„ ì¶”ê°€í•©ë‹ˆë‹¤.</li>
        <li><span class="num">3</span>ìë¥´ê³  ì‹¶ì€ êµ¬ê°„ì„ ì§€ì •í•˜ê³  <b>ìë¥´ê¸°</b> í´ë¦­!</li>
        <li><span class="num">4</span>í•„í„°/ìë§‰/ì†ë„ ë“± ì›í•˜ëŠ” ì˜µì…˜ì„ ì ìš©í•˜ì„¸ìš”.</li>
        <li><span class="num">5</span>ì—¬ëŸ¬ í´ë¦½ì„ ë§Œë“¤ê³  <b>í˜ì´ë“œ ë³‘í•©</b>ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
        <li><span class="num">6</span>ëª¨ë“  í¸ì§‘ì´ ëë‚˜ë©´ <b>ë‹¤ìš´ë¡œë“œ</b> ë²„íŠ¼ìœ¼ë¡œ ì €ì¥!</li>
      </ul>
    </div>

    <!-- FAQ -->
    <div class="faq-section">
      <h2>ğŸ’¡ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ & ì•ˆë‚´</h2>
      <ul class="faq-list">
        <li>
          <div class="faq-q">Q. ì–´ë–¤ ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©í•´ì•¼ í•˜ë‚˜ìš”?</div>
          <div class="faq-a">ì—£ì§€ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ì˜€ê¸°ì— ì—£ì§€ë¥¼ ì‚¬ìš© í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</div>
        </li>
        <li>
          <div class="faq-q">Q. ë‚´ ì˜ìƒ/ìŒì•…ì´ ì˜ ì—…ë¡œë“œê°€ ì•ˆ ë  ë•Œ?</div>
          <div class="faq-a">ìš©ëŸ‰ì´ ë„ˆë¬´ í¬ê±°ë‚˜ í¬ë§·ì´ íŠ¹ì´í•  ê²½ìš° ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. mp4/mp3ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</div>
        </li>
        <li>
          <div class="faq-q">Q. ëª¨ë“  ê¸°ëŠ¥ì´ ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ ë™ì‘í•˜ë‚˜ìš”?</div>
          <div class="faq-a">ë„¤! ëª¨ë“  í¸ì§‘/í•©ì„±/ì €ì¥ ê¸°ëŠ¥ì€ ì„œë²„ ì—…ë¡œë“œ ì—†ì´ ë‚´ PCì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤. ë‹¤ë§Œ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—…ë°ì´íŠ¸ ì•ˆë ê²½ìš° ë™ì˜ìƒì—ì„œ ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ê°•ì œ ì‹œì‘ í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤.</div>
        </li>
      </ul>
    </div>
  </main>
  <footer>
    <div>ì œì‘ì: <b>ë¬¸ê·œì„±</b></div>
    <div>
      ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œ: <a href="https://github.com/yourusername/shorts-maker" class="gh-link" target="_blank">github.com/yourusername/shorts-maker</a>
    </div>

  </footer>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    const IN_VID     = 'input.mp4',
          TRIMMED    = 'trimmed.mp4',
          IN_AUD     = 'audio.mp3',
          MERGED     = 'merged.mp4',
          FILTERED   = 'filtered.mp4',
          FINAL      = 'final.mp4';

    let ready=false, videoLoaded=false, audioLoaded=false, currentVideo=null;
    let ovText='', ovStart=0, ovEnd=0;
    let clips = []; 
    let loopActive = false;

    // DOM
    const videoInput      = document.getElementById('videoInput');
    const audioInput      = document.getElementById('audioInput');
    const preview         = document.getElementById('preview');
    const overlay         = document.getElementById('subtitleOverlay');
    const startSec        = document.getElementById('startSec');
    const endSec          = document.getElementById('endSec');
    const trimBtn         = document.getElementById('trimBtn');
    const mergeBtn        = document.getElementById('mergeBtn');
    const loopBtn         = document.getElementById('loopBtn');
    const filterSelect    = document.getElementById('filterSelect');
    const applyFilterBtn  = document.getElementById('applyFilterBtn');
    const speedSelect     = document.getElementById('speedSelect');
    const speedBtn        = document.getElementById('speedBtn');
    const thumbTime       = document.getElementById('thumbTime');
    const captureThumbBtn = document.getElementById('captureThumbBtn');
    const subtitleText    = document.getElementById('subtitleText');
    const subtitleStart   = document.getElementById('subtitleStart');
    const subtitleEnd     = document.getElementById('subtitleEnd');
    const subtitleBtn     = document.getElementById('subtitleBtn');
    const clipStart       = document.getElementById('clipStart');
    const clipEnd         = document.getElementById('clipEnd');
    const addClipBtn      = document.getElementById('addClipBtn');
    const fadeMergeBtn    = document.getElementById('fadeMergeBtn');
    const clipList        = document.getElementById('clipList');
    const downloadLink    = document.getElementById('downloadLink');

    (async()=>{
      await ffmpeg.load();
      ready = true;
      updateButtons();
    })();

    function updateButtons(){
      trimBtn.disabled        = !videoLoaded;
      mergeBtn.disabled       = !(videoLoaded && audioLoaded);
      applyFilterBtn.disabled = !videoLoaded;
      speedBtn.disabled       = !videoLoaded;
      captureThumbBtn.disabled= !videoLoaded;
      subtitleBtn.disabled    = !videoLoaded;
      addClipBtn.disabled     = !videoLoaded;
      fadeMergeBtn.disabled   = clips.length < 2;
      loopBtn.disabled        = !videoLoaded;
    }

    // ìë§‰ ì˜¤ë²„ë ˆì´/êµ¬ê°„ë°˜ë³µ
    preview.addEventListener('timeupdate', ()=>{
      const t = preview.currentTime;
      overlay.textContent = (ovText && t>=ovStart && t<=ovEnd) ? ovText : '';
      if (loopActive) {
        const s = parseFloat(startSec.value)||0, e = parseFloat(endSec.value)||0;
        if (e > s && t >= e) {
          preview.currentTime = s;
          preview.play();
        }
      }
    });

    videoInput.addEventListener('change', async e => {
      const f = e.target.files[0];
      if(!f||!ready) return;
      preview.src   = URL.createObjectURL(f);
      preview.muted = true;
      const data = await fetchFile(f);
      ffmpeg.FS('writeFile', IN_VID, data);
      currentVideo = IN_VID;
      videoLoaded  = true;
      updateButtons();
    });

    audioInput.addEventListener('change', async e => {
      const f = e.target.files[0];
      if(!f||!ready) return;
      const data = await fetchFile(f);
      ffmpeg.FS('writeFile', IN_AUD, data);
      audioLoaded = true;
      updateButtons();
    });

    trimBtn.addEventListener('click', async ()=>{
      const s = String(startSec.value), t = String(endSec.value);
      await ffmpeg.run('-i', currentVideo, '-ss', s, '-to', t, '-c', 'copy', TRIMMED);
      const buff = ffmpeg.FS('readFile', TRIMMED);
      const url  = URL.createObjectURL(new Blob([buff.buffer], {type:'video/mp4'}));
      preview.src = url; preview.muted = true; preview.load(); preview.play().catch(()=>{});
      currentVideo = TRIMMED;
      updateButtons();
    });

    mergeBtn.addEventListener('click', async ()=>{
      await ffmpeg.run(
        '-i', currentVideo, '-i', IN_AUD,
        '-map','0:v:0','-map','1:a:0',
        '-c:v','copy','-c:a','aac','-shortest',
        MERGED
      );
      const buff = ffmpeg.FS('readFile', MERGED);
      const url  = URL.createObjectURL(new Blob([buff.buffer], {type:'video/mp4'}));
      preview.src = url; preview.muted = false; preview.load(); preview.play().catch(()=>{});
      currentVideo = MERGED;
      updateButtons();
    });

    filterSelect.addEventListener('change', ()=>{
      const map = {
        'none': 'none',
        'hue=s=0': 'grayscale(100%)',
        'colorchannelmixer=0.393:0.769:0.189:0:0.349:0.686:0.168:0:0.272:0.534:0.131': 'sepia(80%)',
        'eq=contrast=1.5:brightness=0.05': 'contrast(150%) brightness(105%)',
        'eq=saturation=0.5': 'saturate(50%)'
      };
      preview.style.filter = map[filterSelect.value] || 'none';
    });

    applyFilterBtn.addEventListener('click', async ()=>{
      const filter = filterSelect.value;
      await ffmpeg.run('-i', currentVideo, '-vf', filter, '-c:a','copy', FILTERED);
      const buff = ffmpeg.FS('readFile', FILTERED);
      const url  = URL.createObjectURL(new Blob([buff.buffer], {type:'video/mp4'}));
      preview.src = url; preview.muted=false; preview.load(); preview.play().catch(()=>{});
      currentVideo = FILTERED;
      downloadLink.href = url; downloadLink.style.display = 'inline-block';
      updateButtons();
    });

    speedBtn.addEventListener('click', ()=>{
      const f = parseFloat(speedSelect.value);
      preview.playbackRate = f;
    });

    captureThumbBtn.addEventListener('click', ()=>{
      const t = parseFloat(thumbTime.value)||0;
      preview.currentTime = t;
      preview.addEventListener('seeked', function onSeek(){
        preview.removeEventListener('seeked', onSeek);
        const canvas = document.createElement('canvas');
        canvas.width  = preview.videoWidth;
        canvas.height = preview.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(preview,0,0,canvas.width,canvas.height);
        const dataURL = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = dataURL; a.download='thumbnail.png';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      });
    });

    subtitleBtn.addEventListener('click', ()=>{
      const text = subtitleText.value.trim();
      if(!text) return alert('ìë§‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
      ovStart = parseFloat(subtitleStart.value)||0;
      ovEnd   = parseFloat(subtitleEnd.value)||0;
      ovText  = text;
      preview.currentTime = ovStart; preview.load(); preview.play().catch(()=>{});
    });

    function renderClips() {
      clipList.innerHTML = "";
      clips.forEach((c,i)=>{
        const li = document.createElement("li");
        li.className="clip-li";
        li.textContent = `Clip ${i+1}: ${c.rangeText}`;
        const btn = document.createElement("button");
        btn.textContent = "ì‚­ì œ";
        btn.className = "clip-del-btn";
        btn.onclick = ()=>{
          try{ ffmpeg.FS('unlink',c.name); }catch(e){}
          clips.splice(i,1);
          renderClips();
          updateButtons();
        };
        li.appendChild(btn);
        clipList.appendChild(li);
      });
    }

    async function ensureAudioTrack(infile, outfile) {
      try {
        await ffmpeg.run('-i', infile, '-c:v', 'copy', '-c:a', 'aac', '-strict', '-2', '-shortest', outfile);
      } catch (e) {
        await ffmpeg.run('-i', infile, '-f', 'lavfi', '-i', 'anullsrc=channel_layout=stereo:sample_rate=44100', '-c:v', 'copy', '-c:a', 'aac', '-shortest', outfile);
      }
    }

    addClipBtn.addEventListener('click', async ()=>{
      const s = parseFloat(clipStart.value), t = parseFloat(clipEnd.value);
      if(!(s<t)) return alert("ì‹œì‘/ì¢…ë£Œ ì‹œê°„ í™•ì¸");
      const temp = `clip_raw${clips.length}.mp4`;
      const name = `clip${clips.length}.mp4`;
      await ffmpeg.run('-i',currentVideo,'-ss',String(s),'-to',String(t),'-c','copy',temp);
      await ensureAudioTrack(temp, name);
      try { ffmpeg.FS('unlink', temp); } catch(e) {}
      clips.push({name, duration: t-s, rangeText:`${s}sâ†’${t}s`});
      renderClips();
      updateButtons();
    });

    fadeMergeBtn.addEventListener('click', async ()=>{
      const fadeDur = 0.5;
      if(clips.length<2) return alert("ìµœì†Œ 2ê°œ í´ë¦½ í•„ìš”");
      const args = clips.flatMap(c=>['-i',c.name]);
      let filter = "";
      let offset = 0;
      for(let i=1;i<clips.length;i++){
        offset += clips[i-1].duration - fadeDur;
        const prevV = i===1 ? "[0:v]" : `[v${i-1}]`;
        const currV = `[${i}:v]`;
        const outV  = `[v${i}]`;
        const prevA = i===1 ? "[0:a]" : `[a${i-1}]`;
        const currA = `[${i}:a]`;
        const outA  = `[a${i}]`;
        filter += `${prevV}${currV}xfade=transition=fade:duration=${fadeDur}:offset=${offset.toFixed(2)}${outV};`;
        filter += `${prevA}${currA}acrossfade=d=${fadeDur}${outA}${i<clips.length-1?';':''}`;
      }
      args.push(
        '-filter_complex', filter,
        '-map', `[v${clips.length-1}]`,
        '-map', `[a${clips.length-1}]`,
        '-c:v','libx264','-crf','23','-preset','fast',
        FINAL
      );
      await ffmpeg.run(...args);
      const buff = ffmpeg.FS('readFile', FINAL);
      const url  = URL.createObjectURL(new Blob([buff.buffer],{type:'video/mp4'}));
      preview.src = url; preview.muted=false; preview.load(); preview.play().catch(()=>{});
      downloadLink.href = url; downloadLink.style.display = 'inline-block';
    });

    loopBtn.addEventListener('click', ()=>{
      loopActive = !loopActive;
      loopBtn.textContent = loopActive ? "ğŸ” êµ¬ê°„ ë°˜ë³µ ON" : "ğŸ” êµ¬ê°„ ë°˜ë³µ OFF";
      if(loopActive) {
        preview.currentTime = parseFloat(startSec.value)||0;
        preview.play();
      }
    });

    preview.addEventListener('loadedmetadata', ()=>{
      preview.playbackRate = parseFloat(speedSelect.value);
      videoLoaded=true; updateButtons();
    });
  </script>
</body>
</html>
